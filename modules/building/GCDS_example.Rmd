---
title: "GCDS: Example"
#author: "gcook"
#date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: yes
    number_sections: yes
    highlight: pygments
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE, include=FALSE}
rm(list = ls(all.names = TRUE))

# load externals
source("https://pastebin.com/raw/b63hB7Hj")

# a better view function
view <- function(object, rows = F, show = 100, ...) { 
    get_Packages(c("DT"), load = F) # check if library is installed
    # check appropriateness of data structure
  if (tibble::is_tibble(object)) {
    object = as.data.frame(object)
  }  
  if (is.null(dim(object)) & class(object) == "list") {
        message("Object is a list. Viewer displays last list element. Consider passing each element to view().")
        lapply(object, function(x) { DT::datatable(x, rownames = rows, options = list(pageLength = show)) }) 
    } else {
        DT::datatable(object, rownames = rows, options = list(pageLength = show)) 
    }
}

# some objects to work with
this_rmd_path = rstudioapi::getActiveDocumentContext()$path
proj_name = ""
proj_dir <- gsub("r/.*.Rmd","", this_rmd_path)
r_dir <- paste0(proj_dir, "r/")
data_dir <- paste0(proj_dir, "data/")
```

Load libraries. Note how loading matters and can lead to masking functions.  

```{r}
# load some libraries
library(tidyverse)
library(gtsummary)
library(magrittr)
library(performance)
library(modelbased)
library(see)
library(readr)
```

```{r message=FALSE, warning=FALSE, include=FALSE}

```



Read some data?

Within [DSRR datasets](https://psyteachr.github.io/reprores-v2/datasets.html), there are *First Impressions of Faces* from the Psychological Science Accelerator project called ["To Which World Regions Does the Valence-Dominance Model of Social Perception Apply?"](https://psyarxiv.com/n26dy).  The data include average (e.g., mean) ratings on 13 traits for 120 different faces which were shown to people in in 10 world regions. 

Because there are so many variables in this data set, it serves as a good example to explore and plot from.

```{r message=FALSE, warning=FALSE}
DAT <- read_csv(paste0(data_dir, "psa001_agg.csv")) # face data

DAT2 <- read_csv(paste0(data_dir, "pets.csv"))   # pet data also at DSRR
```


View it in html?

```{r}
# uses the function defined at the top of the file
view(DAT, show = 10)
```


Working with a data base of faces rated on various dimensions. Need to create new variables based on existing ones?

```{r message=FALSE, warning=FALSE}
DAT <- DAT %>% 
  # create new variables based on characters
  mutate(sex  = ifelse(grepl("F", stim_id), "Female", "Male"), # using ifelse()
         race = case_when(grepl("B", stim_id) ~ "Black",       # easier using dplyr::case_when()
                          grepl("A", stim_id) ~ "Asian",
                          grepl("W", stim_id) ~ "White",
                          grepl("L", stim_id) ~ "Latino"
                          )
  ) %>%
  # dplyr::select(stim_id, attractive, caring, intelligent, mean, unhappy) %>%
  select(-stim_id) %>%                                # remove 1 ,  - means subtract out
  select(-c(responsible, sociable, weird, emostable)) # remove multiple, -c()
```



Pet data? Barplots? 

```{r}
p1 <- DAT2 %>%
  group_by(pet) %>%
  summarise(
    age = mean(age, na.rm = T),
    weight = mean(weight, na.rm = T),
  ) %>%
  ggplot(aes(x = pet, y = age), fill = pet) +
  geom_col() +
  labs(x = "Pet", y = "Mean Age") +
  see::theme_modern()
p1

p1 <- DAT2 %>%
  ggplot(., aes(x = weight, 
                y = pet, 
                fill = pet)) + 
  geom_bar(stat = "summary", fun = "mean") + # or stat_summary(fun = "mean", geom = "bar") +
  labs(x = "Pet", y = "Mean Weight") +
  see::theme_modern() 
p1
```


Flip the coordinates and change fill color?

```{r}
p2 <- p1 + 
  aes(x = age) +                                                 # change the aestheics
  scale_fill_manual(values = c("#0033FF", "green", "black")) +   # choose colors
  labs(x = "Pet", y = "Mean Weight") +
  coord_flip()
p2
```

Overlay a boxplot; flag outlier as red triangle? Plot with previous? Though this looks **ugly**.

```{r}
p2 <- p2 + geom_boxplot(notch = T, 
                  outlier.shape = 2, 
                  outlier.color = "red")

gridExtra::grid.arrange(p1, p2)
```


Scatter plot and marginal box plots?

```{r}
p3 <- DAT2 %>% ggplot(aes(
  x = age, 
  y = weight)) + 
  geom_point(aes(colour = pet)) +
  see::theme_modern() + ggtitle("Pet Weight and Age Data")

ggExtra::ggMarginal(
  p3,
  type = 'boxplot',
  margins = 'both',
  size = 5,
  groupColour = TRUE,
  groupFill = TRUE
  )
```


A correlation matrix for face ratings?

```{r message=FALSE, warning=FALSE}
DAT_corr <- correlation::correlation(DAT)

DAT_corr %>%
  summary(redundant = F) %>%
  plot() +           # make the plot
  theme_classic() +  # general classic theme from ggplot2
  ggtitle("Correlation Matrix of Dimensions of Rated Faces") # add your own title
```

Another matrix, with a different theme?

```{r message=FALSE, warning=FALSE}
DAT %>%
  correlation::correlation(., 
                           method = "pearson",
                           winsorize = T
                           ) %>%
  summary(., redundant = F) %>%
  plot() +            # plot 
  ggtitle("Correlation Matrix of Dimensions of Rated Faces") +    # add your own title
  see::theme_modern() # clean up the plot and put in a modern theme
```


A scatter plot between aggressive and mean ratings?

```{r message=FALSE, warning=FALSE}
DAT %>% ggplot(aes(
  x = trustworthy, 
  y = attractive)) + 
  geom_point(aes(colour = sex))
```

Flip the coordinates?

```{r message=FALSE, warning=FALSE}
DAT %>% ggplot(aes(
  x = trustworthy, 
  y = attractive)) + 
  geom_point(aes(colour = sex)) +
  coord_flip()
```


Separate scatter plots with a regression line for each race?

```{r message=FALSE, warning=FALSE}
DAT %>% ggplot(aes(
  x = trustworthy, 
  y = attractive)) + 
  geom_point(aes(colour = sex)) +
  geom_smooth(method = "lm") + 
  facet_wrap("race") 
```

Separate scatter plots with a loess line for each race?

```{r message=FALSE, warning=FALSE}
DAT %>% ggplot(aes(
  x = trustworthy, 
  y = attractive)) + 
  geom_point(aes(colour = sex)) +
  geom_smooth(method = "loess") + 
  facet_wrap("race") 
```


A linear model?

```{r message=FALSE, warning=FALSE}
DAT %>%
  lm(trustworthy ~ attractive, data = .) %>%
  summary() %>%
  broom::tidy() #%>%
  #htmlTable::htmlTableWidget()

```

A linear model in a different way?

```{r message=FALSE, warning=FALSE}
DAT %>%
  lm(trustworthy ~ attractive, .) %>%
  gtsummary::tbl_regression()
```


A simple regression model with assumption checks?

```{r message=FALSE, warning=FALSE}
DAT %>%
  lm(trustworthy ~ attractive, data = .) %>% # defining a model
  check_model() # checking model assumptions
```

A multiple regression model?

```{r message=FALSE, warning=FALSE}
DAT %>%
  lm(trustworthy ~ attractive + caring, .) %>%
  gtsummary::tbl_regression()
```

A multiple regression model with assumption checks?

```{r message=FALSE, warning=FALSE}
DAT %>%
  lm(trustworthy ~ attractive + caring, data = .) %>%
  check_model() # checking model assumptions
```


A gaussian graphical model?

```{r message=FALSE, warning=FALSE}
library(ggraph) 

DAT %>%
  correlation::correlation(partial = TRUE) %>%
  plot()
```


How about a summary table? 

```{r message=FALSE, warning=FALSE}
DAT %>% 
  # remove from summary table
  dplyr::select(-region) %>% 
  tbl_summary(by = race)
```

Choose your own stats?

```{r message=FALSE, warning=FALSE}
DAT %>% 
  # remove from summary table
  dplyr::select(-region) %>% 
  tbl_summary(by = race,
    # custom statistic formats ----
    statistic = list(all_continuous() ~ "{mean} ({sd})",
                     all_categorical() ~ "{p}% ({n} / {N})")
  ) 
```

Add some styling?

```{r message=FALSE, warning=FALSE}
DAT %>% 
  # remove from summary table
  dplyr::select(-region) %>% 
  dplyr::select(-sex) %>%
  tbl_summary(by = race,
    # custom statistic formats ----
    statistic = list(all_continuous() ~ "{mean} ({sd})",
                     all_categorical() ~ "{p}% ({n} / {N})")
  ) %>%
  add_overall() %>%     # add an overall column
  add_n() %>%           # add column with total number of non-missing observations
  add_p() %>%           # test for a difference between groups
  bold_labels() 
```
